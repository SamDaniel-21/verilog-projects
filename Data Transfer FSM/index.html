#include <WiFi.h>
#include <WebServer.h>

// ------------------- CONFIGURATION -------------------
const char* ssid = "YOUR_WIFI_NAME";      // CHANGE THIS
const char* password = "YOUR_WIFI_PASSWORD";  // CHANGE THIS
const int sensorPin = 34; // Connect Analog Output of Smoke Sensor to GPIO 34
// -----------------------------------------------------

WebServer server(80);

// We store the HTML page as a variable here so we don't need SD cards/SPIFFS
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Smoke Monitor</title>
    <style>
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --safe-color: #2ecc71; --danger-color: #e74c3c; --text-color: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: var(--text-color); }
        .dashboard { background: var(--card-bg); padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 300px; }
        h1 { margin-top: 0; font-size: 1.5rem; color: #555; }
        .status-indicator { width: 120px; height: 120px; border-radius: 50%; margin: 20px auto; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold; color: white; transition: all 0.3s ease; }
        .safe { background-color: var(--safe-color); box-shadow: 0 0 15px var(--safe-color); }
        .danger { background-color: var(--danger-color); box-shadow: 0 0 20px var(--danger-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .data-display { display: flex; justify-content: space-between; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .data-box h3 { margin: 0; font-size: 0.9rem; color: #777; }
        .data-box p { margin: 5px 0 0; font-size: 1.2rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>ðŸ’¨ ESP32 Monitor</h1>
        <div id="statusCircle" class="status-indicator safe">SAFE</div>
        <div class="data-display">
            <div class="data-box">
                <h3>Sensor Value</h3>
                <p id="ppmValue">0</p>
            </div>
            <div class="data-box">
                <h3>Last Update</h3>
                <p id="timestamp">--:--:--</p>
            </div>
        </div>
    </div>

    <script>
        const ALARM_THRESHOLD = 2000; // Adjust based on your sensor calibration
        
        const statusCircle = document.getElementById('statusCircle');
        const ppmDisplay = document.getElementById('ppmValue');
        const timeDisplay = document.getElementById('timestamp');

        function updateDashboard(ppm) {
            ppmDisplay.innerText = ppm;
            const now = new Date();
            timeDisplay.innerText = now.toLocaleTimeString();

            if (ppm > ALARM_THRESHOLD) {
                statusCircle.className = 'status-indicator danger';
                statusCircle.innerText = 'ALERT';
            } else {
                statusCircle.className = 'status-indicator safe';
                statusCircle.innerText = 'SAFE';
            }
        }

        // --- FETCH DATA FROM ESP32 ---
        function getSensorData() {
            fetch('/data')  // Call the ESP32 endpoint
                .then(response => response.json())
                .then(data => {
                    console.log("Received:", data);
                    updateDashboard(data.ppm);
                })
                .catch(err => console.error("Error fetching data:", err));
        }

        // Check for new data every 2 seconds
        setInterval(getSensorData, 2000);
    </script>
</body>
</html>
)rawliteral";

// --- HANDLER: Serve the HTML page ---
void handleRoot() {
  server.send(200, "text/html", index_html);
}

// --- HANDLER: Send JSON Data (e.g., {"ppm": 1200}) ---
void handleData() {
  int sensorValue = analogRead(sensorPin);
  
  // Create JSON string
  String json = "{\"ppm\":" + String(sensorValue) + "}";
  
  server.send(200, "application/json", json);
}

void setup() {
  Serial.begin(115200);
  
  // Connect to Wi-Fi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());

  // Define Server Routes
  server.on("/", handleRoot);
  server.on("/data", handleData);

  server.begin();
  Serial.println("Web Server started");
}

void loop() {
  server.handleClient();
}